<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Labelly</title>

  <link rel="icon" href="/favicon.svg" type="image/svg+xml" />

  <meta property="og:title" content="Labelly" />
  <meta property="og:description" content="é…é€ãƒ»è¿”å“ãƒ»è¡¨è¨˜ãªã©ã€è¦‹è½ã¨ã—ã‚„ã™ã„æ¡ä»¶ã‚’äº‹å‰ã«è¦‹ãˆã‚‹åŒ–ã—ã¾ã™ã€‚" />
  <meta property="og:image" content="/og.svg" />
  <meta property="og:type" content="website" />

  <style>
    :root {
      --bg: #f3f6fb;
      --panel: #ffffff;
      --text: #0f172a;
      --muted: #64748b;
      --border: #e6edf6;
      --shadow: 0 18px 50px rgba(2, 6, 23, .08);
      --shadow2: 0 10px 30px rgba(2, 6, 23, .06);

      --blue: #2f5bff;
      --nav: #0a0f1f;
      --nav2: #070a12;

      --green: #16a34a;
      --yellow: #f59e0b;
      --orange: #f97316;
      --red: #ef4444;

      --radius: 22px;
    }

    * {
      box-sizing: border-box
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Hiragino Sans", "Noto Sans JP", sans-serif;
      color: var(--text);
      background: radial-gradient(1200px 600px at 50% -200px, rgba(47, 91, 255, .18), transparent 60%), var(--bg);
    }

    /* Header */
    header {
      padding: 16px 18px;
      background: linear-gradient(180deg, var(--nav), var(--nav2));
      position: sticky;
      top: 0;
      z-index: 10;
      box-shadow: 0 14px 50px rgba(0, 0, 0, .25);

      /* è¿½åŠ ï¼šä¸­èº«ã®ç¸¦ä¸­å¤®ï¼ˆä¿é™ºï¼‰ */
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* ãƒ­ã‚´ã®æ¨ªä¸¦ã³ã‚’å¼·åˆ¶ï¼ˆ2æ®µè½ã¡é˜²æ­¢ï¼‰ */
    .brand {
      max-width: 980px;
      margin: 0 auto;
      display: flex;
      flex-direction: row;
      flex-wrap: nowrap;
      /* ã“ã‚ŒãŒé‡è¦ï¼šæŠ˜ã‚Šè¿”ã—ç¦æ­¢ */
      align-items: center;
      /* ã“ã‚ŒãŒé‡è¦ï¼šç¸¦ã‚ºãƒ¬é˜²æ­¢ */
      justify-content: center;
      gap: 14px;
    }

    .brand svg {
      display: inline;
      /* baselineã‚ºãƒ¬å¯¾ç­– */
      width: 44px;
      height: 44px;
      /* ã“ã‚ŒãŒé‡è¦ï¼šæ¯”ç‡å´©ã‚Œ/ä¸¸ã‚ºãƒ¬å¯¾ç­– */
      flex: 0 0 44px;
    }

    .brand .word {
      font-weight: 900;
      letter-spacing: .4px;
      font-size: 28px;
      color: #fff;
      line-height: 1;
      white-space: nowrap;
      /* ã“ã‚ŒãŒé‡è¦ï¼šæ–‡å­—ã®æŠ˜è¿”ã—é˜²æ­¢ */
      transform: none;
      /* transformãŒã‚ã‚‹ã¨ç’°å¢ƒã§ã‚ºãƒ¬ã‚‹ã®ã§ç„¡åŠ¹åŒ– */
    }


    .wrap {
      max-width: 980px;
      margin: 28px auto 60px;
      padding: 0 16px;
    }

    .hero {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 26px 26px 22px;
    }

    .hero h1 {
      margin: 0 0 10px;
      font-size: 18px;
      font-weight: 600;
      color: #334155;
      text-align: center;
      letter-spacing: .2px;
    }

    .hero p {
      margin: 0 0 18px;
      color: var(--muted);
      text-align: center;
      line-height: 1.7;
    }

    .inputRow {
      display: grid;
      grid-template-columns: 1fr 110px;
      gap: 14px;
      align-items: center;
      margin-top: 12px;
    }

    input[type="url"] {
      width: 100%;
      font-size: 18px;
      padding: 16px 18px;
      border-radius: 14px;
      border: 2px solid #dbe7ff;
      outline: none;
      background: #eef4ff;
      transition: .15s;
    }

    input[type="url"]:focus {
      border-color: rgba(47, 91, 255, .55);
      box-shadow: 0 0 0 4px rgba(47, 91, 255, .12);
      background: #f7faff;
    }

    button {
      border: 0;
      background: var(--blue);
      color: #fff;
      border-radius: 14px;
      padding: 15px 16px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 12px 26px rgba(47, 91, 255, .25);
      transition: .15s transform, .15s filter;
    }

    button:hover {
      filter: brightness(1.02)
    }

    button:active {
      transform: translateY(1px)
    }

    button:disabled {
      opacity: .6;
      cursor: not-allowed;
      box-shadow: none;
    }

    .note {
      margin-top: 12px;
      text-align: center;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.7;
    }

    /* result card */
    .result {
      margin-top: 20px;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    .resultHead {
      padding: 20px 22px 16px;
      border-bottom: 1px solid var(--border);
    }

    .titleRow {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }

    .titleLeft {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 600;
      font-size: 26px;
      letter-spacing: .2px;
    }

    .dot {
      width: 14px;
      height: 14px;
      border-radius: 999px;
      display: inline-block;
      box-shadow: 0 0 0 5px rgba(0, 0, 0, .03);
      flex: 0 0 auto;
    }

    .badges {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
      justify-content: flex-end;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      border-radius: 999px;
      padding: 8px 12px;
      font-size: 13px;
      font-weight: 600;
      border: 1px solid #e2e8f0;
      background: #f1f5f9;
      color: #334155;
      white-space: nowrap;
    }

    .badge.dark {
      background: #0b1226;
      border-color: #0b1226;
      color: #fff;
    }

    .badge .miniDot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #94a3b8;
      box-shadow: 0 0 0 4px rgba(0, 0, 0, .04);
    }

    .summaryRow {
      margin-top: 14px;
      display: grid;
      grid-template-columns: 170px 1fr;
      gap: 14px;
      align-items: stretch;
    }

    .scoreCard {
      border: 1px solid var(--border);
      border-radius: 18px;
      background: #fff;
      box-shadow: var(--shadow2);
      padding: 14px 14px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      min-height: 92px;
    }

    .scoreTop {
      display: flex;
      align-items: flex-end;
      justify-content: space-between;
      gap: 10px;
    }

    .scoreLabel {
      font-size: 13px;
      font-weight: 600;
      color: #475569;
    }

    .scoreNum {
      font-size: 24px;
      font-weight: 600;
      letter-spacing: .2px;
      color: #0f172a;
    }

    .bar {
      height: 10px;
      border-radius: 999px;
      background: #e8eef9;
      overflow: hidden;
      border: 1px solid #e6edf6;
    }

    .bar>div {
      height: 100%;
      width: 0%;
      border-radius: 999px;
      background: var(--blue);
      transition: width .3s ease;
    }

    .scoreText {
      border: 1px solid var(--border);
      border-radius: 18px;
      background: #fff;
      box-shadow: var(--shadow2);
      padding: 14px 14px;
      min-height: 92px;
    }

    .scoreGrade {
      font-weight: 600;
      font-size: 16px;
      margin-bottom: 6px;
    }

    .scoreDesc {
      color: #475569;
      font-weight: 800;
      line-height: 1.7;
      font-size: 13px;
    }

    .oneLine {
      margin-top: 14px;
      padding: 14px 14px;
      border-radius: 14px;
      background: #f1f5f9;
      color: #0f172a;
      font-weight: 600;
      line-height: 1.65;
      display: flex;
      gap: 10px;
      align-items: flex-start;
    }

    .oneLine .bulb {
      font-size: 18px;
      line-height: 1.2
    }

    /* ===== Affiliate (new) ===== */
    .affiliate {
      margin-top: 12px;
      border: 1px solid #e2e8f0;
      background: #fbfdff;
      border-radius: 16px;
      padding: 12px 12px;
      box-shadow: var(--shadow2);
      display: none;
      /* JSã§æ¡ä»¶è¡¨ç¤º */
    }

    .affiliateTitle {
      font-weight: 600;
      font-size: 14px;
      color: #0f172a;
      margin: 0 0 6px;
    }

    .affiliateText {
      color: #475569;
      font-weight: 800;
      font-size: 13px;
      line-height: 1.7;
      margin: 0 0 10px;
    }

    .affBtns {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .affBtn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid #dbe7ff;
      background: #eef4ff;
      color: #0f172a;
      font-weight: 600;
      font-size: 13px;
      text-decoration: none;
      cursor: pointer;
      transition: .15s filter, .15s transform;
      white-space: nowrap;
    }

    .affBtn:hover {
      filter: brightness(1.02)
    }

    .affBtn:active {
      transform: translateY(1px)
    }

    .affBtn.primary {
      background: var(--blue);
      color: #fff;
      border-color: var(--blue);
    }

    .affFine {
      margin-top: 8px;
      font-size: 12px;
      color: #64748b;
      line-height: 1.6;
    }

    /* ===== /Affiliate ===== */

    .grid3 {
      padding: 18px 22px 6px;
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 14px;
    }

    .mini {
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 16px 16px;
      background: #fff;
      box-shadow: var(--shadow2);
      min-height: 90px;
    }

    .mini .k {
      color: var(--muted);
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 8px;
    }

    .mini .v {
      font-size: 18px;
      font-weight: 600;
      line-height: 1.45;
    }

    .split {
      border-top: 1px solid var(--border);
      padding: 18px 22px 24px;
      display: grid;
      grid-template-columns: 1.2fr .8fr;
      gap: 14px;
    }

    .box {
      border: 1px solid var(--border);
      border-radius: 18px;
      background: #fff;
      padding: 16px 16px;
      box-shadow: var(--shadow2);
      min-height: 160px;
    }

    .box h3 {
      margin: 0 0 10px;
      font-size: 18px;
      font-weight: 600;
    }

    ul {
      margin: 0;
      padding-left: 20px;
      color: #0f172a;
      line-height: 1.8;
    }

    li {
      margin: 6px 0
    }

    .muted {
      color: var(--muted);
    }

    .evidenceWrap {
      padding: 0 22px 22px;
    }

    .toggle {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      user-select: none;
      color: var(--blue);
      font-weight: 600;
      margin-top: 12px;
    }

    .toggle .tri {
      display: inline-block;
      transform: rotate(0deg);
      transition: .15s
    }

    .toggle.open .tri {
      transform: rotate(90deg)
    }

    .evidence {
      margin-top: 12px;
      border: 1px solid var(--border);
      border-radius: 18px;
      background: #fff;
      box-shadow: var(--shadow2);
      padding: 14px 14px;
      display: none;
    }

    .evidence.open {
      display: block;
    }

    .evGrid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .evBox {
      border: 1px solid #e9eef7;
      border-radius: 14px;
      padding: 12px 12px;
      background: #fbfdff;
    }

    .evBox h4 {
      margin: 0 0 10px;
      font-size: 14px;
      font-weight: 600;
      color: #334155;
    }

    .evList {
      margin: 0;
      padding-left: 18px;
      color: #0f172a;
      line-height: 1.7;
      font-size: 13px;
    }

    .evMono {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 12px;
      color: #0f172a;
      background: #f3f6fb;
      border: 1px solid #e5edf8;
      border-radius: 12px;
      padding: 10px 10px;
      overflow: auto;
      white-space: pre-wrap;
      line-height: 1.6;
    }

    .footerNote {
      padding: 0 22px 22px;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.8;
    }

    a {
      color: var(--blue);
      text-decoration: none;
    }

    a:hover {
      text-decoration: underline;
    }

    /* Optional block: emptyãªã‚‰éš ã™ */
    #explanation:empty {
      display: none !important;
    }

    @media (max-width: 820px) {
      .grid3 {
        grid-template-columns: 1fr;
      }

      .split {
        grid-template-columns: 1fr;
      }

      .inputRow {
        grid-template-columns: 1fr;
      }

      button {
        width: 100%;
      }

      .titleLeft {
        font-size: 22px;
      }

      .summaryRow {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>

<body>
  <header>
    <div class="brand" aria-label="Labelly">
      <a href="https://labelly-dzja.onrender.com/" style="text-decoration: none;">
        <svg width="44" height="44" viewBox="0 0 44 44" preserveAspectRatio="xMidYMid meet" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
          <path d="M7 12a6 6 0 0 1 6-6h18l8 10-8 10H13a6 6 0 0 1-6-6V12z" fill="#2f5bff" />
          <circle cx="15.5" cy="18.5" r="3.1" fill="#fff" />
        </svg>
        <div class="word">Labelly</div>
      </a>
    </div>
  </header>

  <main class="wrap">
    <section class="hero">
      <h1>ã“ã®é€šè²©ã‚µã‚¤ãƒˆã§ã€Œã‚ã¨ã‹ã‚‰å›°ã‚‰ãªã„ã‹ï¼Ÿã€</h1>
      <p>é…é€ãƒ»è¿”å“ãƒ»è¡¨è¨˜ãªã©ã€è¦‹è½ã¨ã—ã‚„ã™ã„æ¡ä»¶ã‚’äº‹å‰ã«è¦‹ãˆã‚‹åŒ–ã—ã¾ã™ã€‚</p>

      <div class="inputRow">
        <input id="urlInput" type="url" placeholder="https://example.com" value="" />
        <button id="goBtn">è¨ºæ–­</button>
      </div>

      <div class="note">â€»ã“ã®è¨ºæ–­ã¯å…¬é–‹æƒ…å ±ã‚’ã‚‚ã¨ã«ã—ãŸæ¨å®šã§ã™ã€‚å®Ÿéš›ã®æ¡ä»¶ã¯è²©å£²è€…ã®æ¡ˆå†…ã‚’ã”ç¢ºèªãã ã•ã„ã€‚</div>
    </section>

    <div class="explain" id="explanation"></div>

    <section id="result" class="result" style="display:none;">
      <div class="resultHead">
        <div class="titleRow">
          <div class="titleLeft">
            <span id="dot" class="dot"></span>
            <span id="labelText">â€”</span>
          </div>

          <div class="badges">
            <span class="badge" id="badgeDomain"><span class="miniDot"></span> ãƒ‰ãƒ¡ã‚¤ãƒ³ï¼š-</span>
            <span class="badge dark" id="badgePlatform"><span class="miniDot"></span> æ¨å®šï¼š-</span>
          </div>
        </div>

        <div class="summaryRow">
          <div class="scoreCard">
            <div class="scoreTop">
              <div class="scoreLabel">ä¿¡é ¼ã‚¹ã‚³ã‚¢</div>
              <div class="scoreNum" id="scoreNum">-</div>
            </div>
            <div class="bar">
              <div id="scoreBar"></div>
            </div>
          </div>

          <div class="scoreText">
            <div class="scoreGrade" id="scoreGrade">â€”</div>
            <div class="scoreDesc" id="scoreDesc">â€”</div>

            <!-- Affiliate block (new) -->
            <div class="affiliate" id="affiliateBlock" aria-label="æ­£è¦ãƒ¢ãƒ¼ãƒ«å°ç·š">
              <div class="affiliateTitle">æ­£è¦ãƒ¢ãƒ¼ãƒ«ã§åŒç­‰å•†å“ã‚’æ¢ã™</div>
              <p class="affiliateText" id="affiliateText">â€”</p>
              <div class="affBtns">
                <a class="affBtn primary" id="affAmazon" href="#" target="_blank" rel="noopener noreferrer">Amazonã§æ¢ã™</a>
                <a class="affBtn" id="affRakuten" href="#" target="_blank" rel="noopener noreferrer">æ¥½å¤©ã§æ¢ã™</a>
              </div>
              <div class="affFine">â€»ã‚¢ãƒ•ã‚£ãƒªã‚¨ã‚¤ãƒˆãƒªãƒ³ã‚¯ã‚’å«ã¿ã¾ã™ã€‚</div>
            </div>
            <!-- /Affiliate block -->
          </div>
        </div>

        <div id="oneLine" class="oneLine" style="display:none;">
          <span class="bulb">ğŸ’¡</span>
          <div id="oneLineText"></div>
        </div>
      </div>

      <div class="grid3">
        <div class="mini">
          <div class="k">é…é€</div>
          <div class="v" id="delivery">-</div>
        </div>
        <div class="mini">
          <div class="k">åˆ°ç€ç›®å®‰</div>
          <div class="v" id="eta">-</div>
        </div>
        <div class="mini">
          <div class="k">è¿”å“</div>
          <div class="v" id="ret">-</div>
        </div>
      </div>

      <div class="split">
        <div class="box">
          <h3>ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆ</h3>
          <ul id="notesList"></ul>
        </div>

        <div class="box">
          <h3>å‘ã„ã¦ã„ã‚‹äºº</h3>
          <ul id="goodList"></ul>

          <div style="height:12px;"></div>

          <h3>æ³¨æ„ã—ãŸã„äºº</h3>
          <ul id="cautionList"></ul>

          <div class="toggle" id="toggleEvidence">
            <span class="tri">â–¶</span> åˆ¤å®šã®æ ¹æ‹ ã‚’è¦‹ã‚‹
          </div>
        </div>
      </div>

      <div class="evidenceWrap">
        <div id="evidence" class="evidence">
          <div class="evGrid">
            <div class="evBox">
              <h4>UI / åŸºæœ¬æƒ…å ±</h4>
              <ul class="evList" id="evUi"></ul>
            </div>
            <div class="evBox">
              <h4>é…é€ã®æ ¹æ‹ </h4>
              <ul class="evList" id="evShip"></ul>
            </div>
            <div class="evBox">
              <h4>è¿”å“ãƒ»è¡¨è¨˜ã®æ ¹æ‹ </h4>
              <ul class="evList" id="evRet"></ul>
            </div>
            <div class="evBox">
              <h4>ç¢ºèªã—ãŸURL</h4>
              <div class="evMono" id="evUrls"></div>
            </div>
          </div>

          <div style="height:12px;"></div>

          <div class="evBox">
            <h4>æŠ½å‡ºã—ãŸæŠœç²‹ï¼ˆçŸ­ã„æŠœç²‹ã®ã¿ï¼‰</h4>
            <div class="evMono" id="evSnips"></div>
          </div>
        </div>
      </div>

      <div class="footerNote">
        â€»æœ¬è¨ºæ–­ã¯å…¬é–‹æƒ…å ±ã‚’ã‚‚ã¨ã«ã—ãŸæ¨å®šã§ã™ã€‚ç‰¹å®šã®äº‹æ¥­è€…ã‚’è©•ä¾¡ãƒ»æ‰¹åˆ¤ã™ã‚‹ã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚å®Ÿéš›ã®ç´æœŸãƒ»è¿”å“æ¡ä»¶ã¯è²©å£²è€…ã®æ¡ˆå†…ã‚’ã”ç¢ºèªãã ã•ã„ã€‚
      </div>
    </section>
  </main>

  <script>
    const $ = (id) => document.getElementById(id);

    const urlInput = $("urlInput");
    const goBtn = $("goBtn");
    const result = $("result");

    const dot = $("dot");
    const labelText = $("labelText");

    const badgeDomain = $("badgeDomain");
    const badgePlatform = $("badgePlatform");

    const scoreNum = $("scoreNum");
    const scoreBar = $("scoreBar");
    const scoreGrade = $("scoreGrade");
    const scoreDesc = $("scoreDesc");

    const affiliateBlock = $("affiliateBlock");
    const affiliateText = $("affiliateText");
    const affAmazon = $("affAmazon");
    const affRakuten = $("affRakuten");

    const oneLine = $("oneLine");
    const oneLineText = $("oneLineText");

    const delivery = $("delivery");
    const eta = $("eta");
    const ret = $("ret");

    const notesList = $("notesList");
    const goodList = $("goodList");
    const cautionList = $("cautionList");

    const toggleEvidence = $("toggleEvidence");
    const evidence = $("evidence");

    const evUi = $("evUi");
    const evShip = $("evShip");
    const evRet = $("evRet");
    const evUrls = $("evUrls");
    const evSnips = $("evSnips");

    // ===== Affiliate IDs =====
    const AMAZON_TAG = "ksmtaka-22";
    const RAKUTEN_AFF = "4f46af35.2e32b7db.4f46af36.85561797";

    function setDotColor(color) {
      const map = {
        green: "var(--green)",
        yellow: "var(--yellow)",
        orange: "var(--orange)",
        red: "var(--red)",
      };
      dot.style.background = map[color] || "var(--muted)";
    }

    function platformJa(p) {
      const m = {
        amazon: "Amazon",
        rakuten: "æ¥½å¤©",
        base: "BASE",
        shopify: "Shopify",
        stores: "STORES",
        unknown: "ä¸æ˜",
      };
      return m[p] || p || "ä¸æ˜";
    }

    function scoreCopy(score, color) {
      const s = Number.isFinite(score) ? score : 0;

      const grade =
        (color === "green" || s >= 75) ? "é«˜ã„ï¼ˆã‹ãªã‚Šå®‰å¿ƒï¼‰" :
          (color === "yellow" || s >= 50) ? "ä¸­ï¼ˆè¦ç¢ºèªï¼‰" :
            "ä½ã€œè¦æ³¨æ„ï¼ˆäº‹å‰ç¢ºèªå¿…é ˆï¼‰";

      const desc =
        (color === "green" || s >= 75)
          ? "ç‰¹å•†æ³•ãƒ»é€£çµ¡å…ˆãƒ»è¿”å“ãªã©ã®æƒ…å ±ãŒæƒã£ã¦ã„ã‚‹å¯èƒ½æ€§ãŒé«˜ã„ã§ã™ã€‚"
          : (color === "yellow" || s >= 50)
            ? "æƒ…å ±ã¯ã‚ã‚‹ãŒæƒã„ãã£ã¦ã„ãªã„å¯èƒ½æ€§ã€‚é…é€ãƒ»è¿”å“ãƒ»ç‰¹å•†æ³•ãƒšãƒ¼ã‚¸ã‚’å…ˆã«ç¢ºèªæ¨å¥¨ã€‚"
            : "å…¬é–‹æƒ…å ±ã®å–å¾—ã‚„æ¡ä»¶ç¢ºèªãŒé›£ã—ã„å¯èƒ½æ€§ã€‚è³¼å…¥å‰ã«å¿…ãšè‡ªå·±ç¢ºèªã‚’ã€‚";

      return { grade, desc };
    }

    function clearList(el) { el.innerHTML = ""; }

    function addItems(el, items) {
      clearList(el);
      (items || []).forEach(t => {
        const li = document.createElement("li");
        li.textContent = t;
        el.appendChild(li);
      });
      if (!items || items.length === 0) {
        const li = document.createElement("li");
        li.className = "muted";
        li.textContent = "ï¼ˆæƒ…å ±ãªã—ï¼‰";
        el.appendChild(li);
      }
    }

    function addEvidenceList(el, items) {
      clearList(el);
      (items || []).forEach(t => {
        const li = document.createElement("li");
        li.textContent = t;
        el.appendChild(li);
      });
      if (!items || items.length === 0) {
        const li = document.createElement("li");
        li.className = "muted";
        li.textContent = "ï¼ˆè©²å½“ãªã—ï¼‰";
        el.appendChild(li);
      }
    }

    function escapeHtml(s) {
      return String(s)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;");
    }

    function renderSnippets(snips) {
      const ui = (snips && snips.ui) ? snips.ui : [];
      const ship = (snips && snips.ship) ? snips.ship : [];
      const ret = (snips && snips.ret) ? snips.ret : [];
      const contact = (snips && snips.contact) ? snips.contact : [];

      const lines = [];
      if (ui.length) lines.push("UI:\n- " + ui.join("\n- "));
      if (ship.length) lines.push("é…é€:\n- " + ship.join("\n- "));
      if (ret.length) lines.push("è¿”å“/è¡¨è¨˜:\n- " + ret.join("\n- "));
      if (contact.length) lines.push("é€£çµ¡å…ˆã£ã½ã„è¡¨è¨˜:\n- " + contact.join("\n- "));
      if (!lines.length) lines.push("ï¼ˆæŠœç²‹ãªã—ï¼‰");

      evSnips.innerHTML = escapeHtml(lines.join("\n\n"));
    }

    function renderUrls(urls) {
      if (!urls || !urls.length) {
        evUrls.textContent = "ï¼ˆãªã—ï¼‰";
        return;
      }
      evUrls.innerHTML = urls
        .map(u => `- <a href="${u}" target="_blank" rel="noopener noreferrer">${escapeHtml(u)}</a>`)
        .join("\n");
    }

    // ===== Affiliate helpers =====
    function getKeywordFromUrl(u) {
      try {
        const host = new URL(u).hostname.replace(/^www\./, "");
        const first = host.split(".")[0] || host;
        // URLã£ã½ã„è¨˜å·ã‚’é™¤å»ã—ã¦ã€æœ€ä½é™ã®æ¤œç´¢èªã«
        return decodeURIComponent(first).replace(/[^a-zA-Z0-9ã-ã‚“ã‚¡-ãƒ¶ä¸€-é¾ _-]/g, " ").trim() || host;
      } catch {
        return "";
      }
    }

    function buildAmazonSearchUrl(keyword) {
      const k = encodeURIComponent(keyword || "");
      return `https://www.amazon.co.jp/s?k=${k}&tag=${encodeURIComponent(AMAZON_TAG)}`;
    }

    function buildRakutenSearchUrl(keyword) {
      const k = encodeURIComponent(keyword || "");
      const target = `https://search.rakuten.co.jp/search/mall/${k}/`;
      const enc = encodeURIComponent(target);
      return `https://hb.afl.rakuten.co.jp/hgc/${encodeURIComponent(RAKUTEN_AFF)}/?pc=${enc}&m=${enc}`;
    }

    function updateAffiliate(data) {
      const color = (data && data.color) ? String(data.color) : "";
      const platform = (data && data.platform) ? String(data.platform) : "";

      const shouldShowByColor = (color === "orange" || color === "yellow");
      const isAlreadyMall = (platform === "amazon" || platform === "rakuten");

      if (!shouldShowByColor || isAlreadyMall) {
        affiliateBlock.style.display = "none";
        return;
      }

      const keyword = getKeywordFromUrl(data.url || urlInput.value || "");
      affAmazon.href = buildAmazonSearchUrl(keyword);
      affRakuten.href = buildRakutenSearchUrl(keyword);

      if (color === "yellow") {
        affiliateText.textContent = "â€»æ­£è¦ãƒ¢ãƒ¼ãƒ«ã§åŒç­‰å•†å“ã‚’æ¢ã™ã®ã‚‚ä¸€ã¤ã®é¸æŠã§ã™ã€‚";
      } else {
        affiliateText.textContent = "â€»äº‹å‰ç¢ºèªãŒé›£ã—ã„å ´åˆã€æ­£è¦ãƒ¢ãƒ¼ãƒ«ã§åŒç­‰å•†å“ã‚’æ¢ã™ã¨å®‰å¿ƒã§ã™ã€‚";
      }

      affiliateBlock.style.display = "block";
    }
    // ===== /Affiliate helpers =====

    function render(data) {
      result.style.display = "block";

      const score = Number.isFinite(data.score) ? data.score : 0;

      setDotColor(data.color);
      labelText.textContent = data.labelText || "â€”";

      const domain = (() => {
        try { return new URL(data.url).hostname; } catch { return "-"; }
      })();

      badgeDomain.innerHTML = `<span class="miniDot"></span> ãƒ‰ãƒ¡ã‚¤ãƒ³ï¼š${escapeHtml(domain)}`;
      badgePlatform.innerHTML = `<span class="miniDot"></span> æ¨å®šï¼š${escapeHtml(platformJa(data.platform))}`;

      scoreNum.textContent = String(score);
      scoreBar.style.width = Math.max(0, Math.min(100, score)) + "%";

      const copy = scoreCopy(score, data.color);
      scoreGrade.textContent = copy.grade;
      scoreDesc.textContent = copy.desc;

      // affiliate
      updateAffiliate(data);

      if (data.oneLine) {
        oneLine.style.display = "flex";
        oneLineText.textContent = data.oneLine;
      } else {
        oneLine.style.display = "none";
        oneLineText.textContent = "";
      }

      delivery.textContent = data.delivery || "-";
      eta.textContent = data.eta || "-";
      ret.textContent = data.return || "-";

      addItems(notesList, data.notes);
      addItems(goodList, data.good);
      addItems(cautionList, data.caution);

      const ev = data.evidence || {};
      addEvidenceList(evUi, ev.ui);
      addEvidenceList(evShip, ev.ship);
      addEvidenceList(evRet, ev.ret);
      renderUrls(ev.urlsChecked || []);
      renderSnippets(ev.snippets || {});

      // é–‹é–‰ã¯æ¯å›é–‰ã˜ã‚‹
      evidence.classList.remove("open");
      toggleEvidence.classList.remove("open");
    }

    async function diagnose() {
      const raw = (urlInput.value || "").trim();
      if (!raw) { alert("URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }

      goBtn.disabled = true;
      goBtn.textContent = "è¨ºæ–­ä¸­â€¦";

      try {
        const res = await fetch("/api/diagnose", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ url: raw }),
        });
        if (!res.ok) throw new Error("API error");
        const data = await res.json();
        render(data);
      } catch (e) {
        alert("è¨ºæ–­ã«å¤±æ•—ã—ã¾ã—ãŸã€‚URLã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
      } finally {
        goBtn.disabled = false;
        goBtn.textContent = "è¨ºæ–­";
      }
    }

    goBtn.addEventListener("click", diagnose);
    urlInput.addEventListener("keydown", (e) => { if (e.key === "Enter") diagnose(); });

    toggleEvidence.addEventListener("click", () => {
      const open = evidence.classList.toggle("open");
      toggleEvidence.classList.toggle("open", open);
    });
  </script>
</body>
</html>